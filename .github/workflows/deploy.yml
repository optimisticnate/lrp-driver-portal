name: Build & Deploy LRP

on:
  push:
    branches: [ main ]
    paths:
      # Frontend changes
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'vite.config.*'
      - 'package.json'
      - 'package-lock.json'
      # Backend changes
      - 'functions/**'
      - 'storage.rules'
      - 'firestore.rules'
      - 'firestore.indexes.json'
      # Only trigger on THIS workflow file, not all workflows
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

concurrency:
  group: lrp-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # CHANGE DETECTION
  # ============================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      functions: ${{ steps.filter.outputs.functions }}
      rules: ${{ steps.filter.outputs.rules }}
    steps:
      - uses: actions/checkout@v5

      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'src/**'
              - 'public/**'
              - 'index.html'
              - 'vite.config.*'
              - 'package.json'
              - 'package-lock.json'
            functions:
              - 'functions/**'
            rules:
              - 'firestore.rules'
              - 'firestore.indexes.json'
              - 'storage.rules'

  # ============================================
  # FRONTEND BUILD & DEPLOY
  # ============================================
  build:
    name: Build & Deploy Frontend
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    steps:
      - uses: actions/checkout@v5

      - name: Run color guard
        run: python3 ./scripts/scan_colors.py

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: npm

      - name: Ensure package-lock.json exists
        run: |
          if [ ! -f package-lock.json ]; then
            echo "Generating package-lock.json..."
            npm install --package-lock-only --no-audit --no-fund
          fi

      - name: Validate required secrets
        shell: bash
        env:
          VITE_CALENDAR_API_KEY:             ${{ secrets.VITE_CALENDAR_API_KEY }}
          VITE_CALENDAR_ID:                  ${{ secrets.VITE_CALENDAR_ID }}
          VITE_FIREBASE_API_KEY:             ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN:         ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID:          ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET:      ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID:              ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_VAPID_KEY:           ${{ secrets.VITE_FIREBASE_VAPID_KEY }}
          VITE_FCM_VAPID_KEY:                ${{ secrets.VITE_FCM_VAPID_KEY }}
          VITE_GOOGLE_CLIENT_ID:             ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          VITE_API_BASE_URL:                 ${{ secrets.VITE_API_BASE_URL }}
          VITE_API_SECRET_KEY:               ${{ secrets.VITE_API_SECRET_KEY }}
          VITE_TIME_LOG_CSV:                 ${{ secrets.VITE_TIME_LOG_CSV }}
          VITE_DROP_DAILY_URL:               ${{ secrets.VITE_DROP_DAILY_URL }}
          VITE_TICKETS_EMAIL_ENDPOINT:       ${{ secrets.VITE_TICKETS_EMAIL_ENDPOINT }}
          VITE_SMS_TEST_TO:                  ${{ secrets.VITE_SMS_TEST_TO }}
          VITE_ENABLE_FCM:                   ${{ secrets.VITE_ENABLE_FCM }}
          VITE_SHOW_DEBUG_PANELS:            ${{ secrets.VITE_SHOW_DEBUG_PANELS }}
          VITE_MUIX_LICENSE_KEY:             ${{ secrets.YOUR_MUI_PRO_KEY }}
          HOSTINGER_FTP_HOST:                "145.223.77.125"
          HOSTINGER_FTP_USERNAME:            "u400814892.lakeridepros.xyz"
        run: |
          set -euo pipefail
          required=(
            VITE_CALENDAR_API_KEY VITE_CALENDAR_ID
            VITE_FIREBASE_API_KEY VITE_FIREBASE_AUTH_DOMAIN VITE_FIREBASE_PROJECT_ID
            VITE_FIREBASE_STORAGE_BUCKET VITE_FIREBASE_MESSAGING_SENDER_ID VITE_FIREBASE_APP_ID
            VITE_API_BASE_URL VITE_API_SECRET_KEY
            VITE_TIME_LOG_CSV VITE_DROP_DAILY_URL
            VITE_GOOGLE_CLIENT_ID
            HOSTINGER_FTP_HOST HOSTINGER_FTP_USERNAME
            VITE_MUIX_LICENSE_KEY
          )
          missing=0
          for k in "${required[@]}"; do
            v="${!k:-}"; if [ -z "$v" ]; then echo "::error::Missing secret $k"; missing=1; fi
          done
          if [ "$missing" -ne 0 ]; then exit 1; fi
          echo "‚úÖ All required secrets present"

      - name: Create environment files
        run: |
          cat > .env << 'EOF'
          VITE_CALENDAR_API_KEY=${{ secrets.VITE_CALENDAR_API_KEY }}
          VITE_CALENDAR_ID=${{ secrets.VITE_CALENDAR_ID }}
          VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_VAPID_KEY=${{ secrets.VITE_FIREBASE_VAPID_KEY }}
          VITE_FCM_VAPID_KEY=${{ secrets.VITE_FCM_VAPID_KEY }}
          VITE_GOOGLE_CLIENT_ID=${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
          VITE_API_SECRET_KEY=${{ secrets.VITE_API_SECRET_KEY }}
          VITE_TIME_LOG_CSV=${{ secrets.VITE_TIME_LOG_CSV }}
          VITE_DROP_DAILY_URL=${{ secrets.VITE_DROP_DAILY_URL }}
          VITE_TICKETS_EMAIL_ENDPOINT=${{ secrets.VITE_TICKETS_EMAIL_ENDPOINT }}
          VITE_SMS_TEST_TO=${{ secrets.VITE_SMS_TEST_TO }}
          VITE_ENABLE_FCM=${{ secrets.VITE_ENABLE_FCM }}
          VITE_SHOW_DEBUG_PANELS=${{ secrets.VITE_SHOW_DEBUG_PANELS }}
          VITE_MUIX_LICENSE_KEY=${{ secrets.YOUR_MUI_PRO_KEY }}
          EOF

          cp .env .env.production

      - name: Generate app version
        id: ver
        run: |
          BASE_VERSION=$(jq -r '.version // "0.0.0"' package.json)
          DATE=$(date -u +%Y%m%d)
          RUN=${GITHUB_RUN_NUMBER}
          SHA=$(git rev-parse --short HEAD)
          REF_NAME="${GITHUB_REF_NAME}"
          CHANNEL="canary"

          if [[ "${GITHUB_REF_TYPE}" == "tag" && "${REF_NAME}" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            BASE_VERSION="${REF_NAME#v}"
            CHANNEL="release"
          else
            case "${REF_NAME}" in
              main) CHANNEL="prod" ;;
              develop|dev|beta) CHANNEL="beta" ;;
              *) CHANNEL="canary" ;;
            esac
          fi

          FINAL_VERSION="v${BASE_VERSION}-${CHANNEL}.${DATE}.${RUN}+${SHA}"
          echo "VITE_APP_VERSION=${FINAL_VERSION}" >> "$GITHUB_ENV"
          echo "app_version=${FINAL_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Stamped version: ${FINAL_VERSION}"

      - name: Write version.json
        run: |
          mkdir -p public
          echo "{\"version\":\"${{ steps.ver.outputs.app_version }}\"}" > public/version.json

      - name: Check lockfile sync
        run: npm run lock:check

      - name: Rebuild lockfile if needed
        if: failure()
        run: npm run lock:rebuild

      - name: Install dependencies
        run: npm run ci:install

      - name: Verify WebP assets
        run: npm run images:verify

      - name: Lint
        run: |
          if npm ls eslint --depth=0 >/dev/null 2>&1; then
            npm run lint:fix --if-present || true
            npm run lint --if-present
          else
            echo "Skipping lint (eslint not installed)"
          fi

      - name: Test
        run: |
          if npm ls vitest --depth=0 >/dev/null 2>&1; then npm test; else echo "Skipping tests"; fi

      - name: Clean build artifacts
        run: rm -rf dist .vite node_modules/.vite

      - name: Build
        env:
          DISABLE_IMG_OPT: '1'
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: npm run build:prod

      - name: Upload version artifact
        uses: actions/upload-artifact@v5
        with:
          name: lrp-version
          path: public/version.json

      - name: Verify build output
        run: |
          test -f dist/manifest.webmanifest || echo "‚ö†Ô∏è  manifest.webmanifest missing"
          [ -d "dist/assets" ] || { echo "‚ùå dist/assets missing"; exit 1; }
          ls dist/assets/main-*.js >/dev/null 2>&1 || { echo "‚ùå main-*.js not found"; exit 1; }
          [ -f dist/sw.js ] || { echo "‚ùå sw.js missing"; exit 1; }
          echo "‚úÖ Build artifacts verified"

      - name: Write Hostinger .htaccess
        run: |
          cat > dist/.htaccess <<'HTACCESS'
          AddType application/javascript .js .mjs
          AddType application/json .json .webmanifest
          AddType text/css .css
          AddType image/png .png
          AddType image/x-icon .ico
          AddType image/svg+xml .svg
          AddType image/webp .webp

          # Cache-Control headers
          <IfModule mod_headers.c>
            <FilesMatch "\.(html|htm)$">
              Header set Cache-Control "no-cache, must-revalidate"
            </FilesMatch>

            <FilesMatch "\.(js|mjs)$">
              Header set Cache-Control "public, max-age=0, must-revalidate"
            </FilesMatch>

            <FilesMatch "^.*\.[a-f0-9]{8,}\.(js|mjs|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot)$">
              Header set Cache-Control "public, max-age=31536000, immutable"
            </FilesMatch>
          </IfModule>

          RewriteEngine On
          RewriteBase /
          RewriteCond %{REQUEST_FILENAME} -f [OR]
          RewriteCond %{REQUEST_FILENAME} -d
          RewriteRule ^ - [L]
          RewriteRule ^(firebase-messaging-sw\.js|sw\.js|service-worker\.js|manifest\.webmanifest|robots\.txt|sitemap\.xml)$ - [L]
          RewriteRule ^icons/ - [L]
          RewriteRule ^assets/ - [L]
          RewriteRule . /index.html [L]
          HTACCESS

      - name: Deploy to Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: "145.223.77.125"
          username: "u400814892.lakeridepros.xyz"
          password: "m;0C&RhL=AL10b!q"
          protocol: ftp
          local-dir: ./dist/
          server-dir: /public_html/
          log-level: minimal
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/*
            **/src/*

  # ============================================
  # FUNCTIONS & RULES DEPLOYMENT
  # ============================================
  functions:
    name: Deploy Functions & Rules
    runs-on: ubuntu-latest
    needs: changes
    # FIXED: Don't depend on build job - functions can deploy independently
    if: needs.changes.outputs.functions == 'true' || needs.changes.outputs.rules == 'true'
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Google Auth
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}

      # Only setup Java/emulators for rule validation
      - name: Setup Java 21 (for emulator)
        if: needs.changes.outputs.rules == 'true'
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "21"

      - name: Cache Firebase emulators
        if: needs.changes.outputs.rules == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cache/firebase/emulators
          key: firebase-emulators-${{ runner.os }}-v1

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Setup gcloud
        if: needs.changes.outputs.functions == 'true'
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Install Firebase CLI
        run: npm i -g firebase-tools@latest

      - name: Check lockfile sync
        run: npm run lock:check

      - name: Rebuild lockfile if needed
        if: failure()
        run: npm run lock:rebuild

      - name: Install Functions dependencies
        working-directory: functions
        run: npm ci

      - name: Verify Functions dependencies
        working-directory: functions
        run: npm ls firebase-functions firebase-admin twilio nodemailer --depth=0 || true

      - name: Validate Firestore rules (emulator)
        if: needs.changes.outputs.rules == 'true'
        run: npx firebase-tools@latest emulators:exec --only firestore "echo Firestore rules valid ‚úîÔ∏è"

      - name: Functions analyzer boot
        if: needs.changes.outputs.functions == 'true'
        run: npx firebase-tools@latest emulators:exec --only functions "node -e \"console.log('Functions v2 analyzer ‚úî')\""

      # NOTE: Twilio secrets are set ONCE manually, not on every deploy
      # This prevents creating new Secret Manager versions ($0.06 each) on every deployment
      # To update secrets, run manually: firebase functions:secrets:set TWILIO_ACCOUNT_SID --project lrp---claim-portal

      - name: Deploy Firestore & Storage Rules
        if: needs.changes.outputs.rules == 'true'
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
        run: firebase deploy --only firestore:rules,firestore:indexes,storage --project "$FIREBASE_PROJECT_ID" --non-interactive

      - name: Deploy Functions
        if: needs.changes.outputs.functions == 'true'
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
        run: firebase deploy --only functions --project "$FIREBASE_PROJECT_ID" --non-interactive --force

      - name: Setup gcloud
        if: needs.changes.outputs.functions == 'true'
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Pin env vars on Cloud Run (apiCalendarFetch)
        if: needs.changes.outputs.functions == 'true'
        env:
          GCAL_SA_EMAIL: ${{ secrets.GCAL_SA_EMAIL }}
          GCAL_SA_PRIVATE_KEY: ${{ secrets.GCAL_SA_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          gcloud run services update apicalendarfetch \
            --region=us-central1 \
            --platform=managed \
            --set-env-vars="^@@^GCAL_SA_EMAIL=${GCAL_SA_EMAIL}@@GCAL_SA_PRIVATE_KEY=${GCAL_SA_PRIVATE_KEY}" \
            --quiet

      - name: Configure Cloud Run environment variables
        if: needs.changes.outputs.functions == 'true'
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          GCAL_SA_EMAIL: ${{ secrets.GCAL_SA_EMAIL }}
          GCAL_SA_PRIVATE_KEY: ${{ secrets.GCAL_SA_PRIVATE_KEY }}
          GMAIL_SENDER: ${{ secrets.GMAIL_SENDER }}
          GMAIL_REPLY_TO: ${{ secrets.GMAIL_REPLY_TO }}
        run: |
          REGION="us-central1"

          echo "üìß Configuring Cloud Run environment variables..."

          # Common env vars for email functions
          EMAIL_VARS="^@@^GCAL_SA_EMAIL=${GCAL_SA_EMAIL}@@GCAL_SA_PRIVATE_KEY=${GCAL_SA_PRIVATE_KEY}@@GMAIL_SENDER=${GMAIL_SENDER}@@GMAIL_REPLY_TO=${GMAIL_REPLY_TO}@@GMAIL_USE_DOMAIN_DELEGATION=true"

          # Calendar function (subset of vars)
          echo "  ‚Ä¢ apiCalendarFetch"
          gcloud run services update apicalendarfetch \
            --region=$REGION \
            --set-env-vars="^@@^GCAL_SA_EMAIL=${GCAL_SA_EMAIL}@@GCAL_SA_PRIVATE_KEY=${GCAL_SA_PRIVATE_KEY}" \
            --quiet 2>/dev/null || echo "    ‚ö†Ô∏è  Service not found or update failed"

          # Email functions (all vars + public access)
          for SERVICE in sendbulkticketsemail sendshuttleticketemail sendnotificationemail; do
            echo "  ‚Ä¢ $SERVICE"

            # Update env vars
            gcloud run services update $SERVICE \
              --region=$REGION \
              --ingress=all \
              --set-env-vars="$EMAIL_VARS" \
              --quiet 2>/dev/null || echo "    ‚ö†Ô∏è  Service update failed"

            # Make public
            gcloud run services add-iam-policy-binding $SERVICE \
              --region=$REGION \
              --member=allUsers \
              --role=roles/run.invoker \
              --quiet 2>/dev/null || echo "    ‚ö†Ô∏è  IAM binding failed"
          done

          echo "‚úÖ Cloud Run configuration complete"

      - name: Configure Supabase environment variables
        if: needs.changes.outputs.functions == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euo pipefail
          REGION="us-central1"

          echo "üîê Configuring Supabase environment variables..."

          # Supabase proxy functions
          for SERVICE in giftcardsquery ordersquery; do
            echo "  ‚Ä¢ $SERVICE"

            gcloud run services update $SERVICE \
              --region=$REGION \
              --set-env-vars="^@@^SUPABASE_URL=${SUPABASE_URL}@@SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}" \
              --quiet 2>/dev/null || echo "    ‚ö†Ô∏è  Service not found or update failed (might not be deployed yet)"
          done

          echo "‚úÖ Supabase configuration complete"
